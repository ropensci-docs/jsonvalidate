<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Safe serialisation of json with unboxing guided by the schema."><title>Safe JSON serialisation — json_serialise • jsonvalidate</title><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://docs.ropensci.org/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Safe JSON serialisation — json_serialise"><meta property="og:description" content="Safe serialisation of json with unboxing guided by the schema."><meta property="og:image" content="https://docs.ropensci.org/jsonvalidate/logo.png"><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Matomo --><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css"><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><p><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript><!-- End Matomo Code --></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a href="https://ropensci.org" class="external-link"><img src="https://ropensci.org/img/icon_short_white.svg" id="hexlogo" alt="rOpenSci"></a>
    <a class="navbar-brand me-2" href="../index.html">jsonvalidate</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.4.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"></ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="nav-link" href="../articles/jsonvalidate.html">Get started</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ropensci/jsonvalidate/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Safe JSON serialisation</h1>
      <small class="dont-index">Source: <a href="https://github.com/ropensci/jsonvalidate/blob/HEAD/R/serialise.R" class="external-link"><code>R/serialise.R</code></a></small>
      <div class="d-none name"><code>json_serialise.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Safe serialisation of json with unboxing guided by the schema.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">json_serialise</span><span class="op">(</span></span>
<span>  <span class="va">object</span>,</span>
<span>  <span class="va">schema</span>,</span>
<span>  engine <span class="op">=</span> <span class="st">"ajv"</span>,</span>
<span>  reference <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  strict <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>object</dt>
<dd><p>An object to be serialised</p></dd>


<dt>schema</dt>
<dd><p>A schema (string or path to a string, suitable to be
passed through to <a href="json_validator.html">json_validator</a> or a validator
object itself.</p></dd>


<dt>engine</dt>
<dd><p>The engine to use. Only ajv is supported, and trying
to use <code>imjv</code> will throw an error.</p></dd>


<dt>reference</dt>
<dd><p>Reference within schema to use for validating against a
sub-schema instead of the full schema passed in. For example
if the schema has a 'definitions' list including a definition for a
'Hello' object, one could pass "#/definitions/Hello" and the validator
would check that the json is a valid "Hello" object. Only available if
<code>engine = "ajv"</code>.</p></dd>


<dt>strict</dt>
<dd><p>Set whether the schema should be parsed strictly or not.
If in strict mode schemas will error to "prevent any unexpected
behaviours or silently ignored mistakes in user schema". For example
it will error if encounters unknown formats or unknown keywords. See
https://ajv.js.org/strict-mode.html for details. Only available in
<code>engine = "ajv"</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>A string, representing <code>object</code> in JSON format. As for
<code><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">jsonlite::toJSON</a></code> we set the class attribute to be <code>json</code> to
mark it as serialised json.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>When using <a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">jsonlite::toJSON</a> we are forced to deal with the
differences between R's types and those available in JSON. In
particular:</p><ul><li><p>R has no scalar types so it is not clear if <code>1</code> should be
serialised as a number or a vector of length 1; jsonlite
provides support for "automatically unboxing" such values
(assuming that length-1 vectors are scalars) or never unboxing
them unless asked to using <a href="https://rdrr.io/pkg/jsonlite/man/unbox.html" class="external-link">jsonlite::unbox</a></p></li>
<li><p>JSON has no date/time values and there are many possible string
representations.</p></li>
<li><p>JSON has no <a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a> or <a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a> type and there are several
ways of representing these in JSON, all equally valid (e.g., row-wise,
column-wise or as an array of objects).</p></li>
<li><p>The handling of <code>NULL</code> and missing values (<code>NA</code>, <code>NaN</code>) are different</p></li>
<li><p>We need to chose the number of digits to write numbers out at,
balancing precision and storage.</p></li>
</ul><p>These issues are somewhat lessened when we have a schema because
we know what our target type looks like.  This function attempts
to use the schema to guide serialsation of json safely.  Currently
it only supports detecting the appropriate treatment of length-1
vectors, but we will expand functionality over time.</p>
<p>For a user, this function provides an argument-free replacement
for <code><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">jsonlite::toJSON</a></code>, accepting an R object and returning a
string with the JSON representation of the object. Internally the
algorithm is:</p><ol><li><p>serialise the object with <a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">jsonlite::toJSON</a>, with
<code>auto_unbox = FALSE</code> so that length-1 vectors are serialised as a
length-1 arrays.</p></li>
<li><p>operating entirely within JavaScript, deserialise the object
with <code>JSON.parse</code>, traverse the object and its schema
simultaneously looking for length-1 arrays where the schema
says there should be scalar value and unboxing these, and
re-serialise with <code>JSON.stringify</code></p></li>
</ol><p>There are several limitations to our current approach, and not all
unboxable values will be found - at the moment we know that
schemas contained within a <code>oneOf</code> block (or similar) will not be
recursed into.</p>
    </div>
    <div class="section level2">
    <h2 id=""></h2>
    <p>Warning:</p>
<p>Direct use of this function will be slow!  If you are going to
serialise more than one or two objects with a single schema, you
should use the <code>serialise</code> method of a
<a href="json_schema.html">json_schema</a> object which you create once and pass around.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># This is the schema from ?json_validator</span></span></span>
<span class="r-in"><span><span class="va">schema</span> <span class="op">&lt;-</span> <span class="st">'{</span></span></span>
<span class="r-in"><span><span class="st">    "$schema": "http://json-schema.org/draft-04/schema#",</span></span></span>
<span class="r-in"><span><span class="st">    "title": "Product",</span></span></span>
<span class="r-in"><span><span class="st">    "description": "A product from Acme\'s catalog",</span></span></span>
<span class="r-in"><span><span class="st">    "type": "object",</span></span></span>
<span class="r-in"><span><span class="st">    "properties": {</span></span></span>
<span class="r-in"><span><span class="st">        "id": {</span></span></span>
<span class="r-in"><span><span class="st">            "description": "The unique identifier for a product",</span></span></span>
<span class="r-in"><span><span class="st">            "type": "integer"</span></span></span>
<span class="r-in"><span><span class="st">        },</span></span></span>
<span class="r-in"><span><span class="st">        "name": {</span></span></span>
<span class="r-in"><span><span class="st">            "description": "Name of the product",</span></span></span>
<span class="r-in"><span><span class="st">            "type": "string"</span></span></span>
<span class="r-in"><span><span class="st">        },</span></span></span>
<span class="r-in"><span><span class="st">        "price": {</span></span></span>
<span class="r-in"><span><span class="st">            "type": "number",</span></span></span>
<span class="r-in"><span><span class="st">            "minimum": 0,</span></span></span>
<span class="r-in"><span><span class="st">            "exclusiveMinimum": true</span></span></span>
<span class="r-in"><span><span class="st">        },</span></span></span>
<span class="r-in"><span><span class="st">        "tags": {</span></span></span>
<span class="r-in"><span><span class="st">            "type": "array",</span></span></span>
<span class="r-in"><span><span class="st">            "items": {</span></span></span>
<span class="r-in"><span><span class="st">                "type": "string"</span></span></span>
<span class="r-in"><span><span class="st">            },</span></span></span>
<span class="r-in"><span><span class="st">            "minItems": 1,</span></span></span>
<span class="r-in"><span><span class="st">            "uniqueItems": true</span></span></span>
<span class="r-in"><span><span class="st">        }</span></span></span>
<span class="r-in"><span><span class="st">    },</span></span></span>
<span class="r-in"><span><span class="st">    "required": ["id", "name", "price"]</span></span></span>
<span class="r-in"><span><span class="st">}'</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># We're going to use a validator object below</span></span></span>
<span class="r-in"><span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu">jsonvalidate</span><span class="fu">::</span><span class="fu"><a href="json_validator.html">json_validator</a></span><span class="op">(</span><span class="va">schema</span>, <span class="st">"ajv"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># And this is some data that we might generate in R that we want to</span></span></span>
<span class="r-in"><span><span class="co"># serialise using that schema</span></span></span>
<span class="r-in"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span>, name <span class="op">=</span> <span class="st">"apple"</span>, price <span class="op">=</span> <span class="fl">0.50</span>, tags <span class="op">=</span> <span class="st">"fruit"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># If we serialise to json, then 'id', 'name' and "price' end up a</span></span></span>
<span class="r-in"><span><span class="co"># length 1-arrays</span></span></span>
<span class="r-in"><span><span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">toJSON</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> {"id":[1],"name":["apple"],"price":[0.5],"tags":["fruit"]} </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># ...and that fails validation</span></span></span>
<span class="r-in"><span><span class="fu">v</span><span class="op">(</span><span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">toJSON</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] FALSE</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># If we auto-unbox then 'fruit' ends up as a string and not an array,</span></span></span>
<span class="r-in"><span><span class="co"># also failing validation:</span></span></span>
<span class="r-in"><span><span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">toJSON</a></span><span class="op">(</span><span class="va">x</span>, auto_unbox <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> {"id":1,"name":"apple","price":0.5,"tags":"fruit"} </span>
<span class="r-in"><span><span class="fu">v</span><span class="op">(</span><span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">toJSON</a></span><span class="op">(</span><span class="va">x</span>, auto_unbox <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] FALSE</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Using json_serialise we can guide the serialisation process using</span></span></span>
<span class="r-in"><span><span class="co"># the schema:</span></span></span>
<span class="r-in"><span><span class="fu">jsonvalidate</span><span class="fu">::</span><span class="fu">json_serialise</span><span class="op">(</span><span class="va">x</span>, <span class="va">schema</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> {"id":1,"name":"apple","price":0.5,"tags":["fruit"]} </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># ...and this way we do pass validation:</span></span></span>
<span class="r-in"><span><span class="fu">v</span><span class="op">(</span><span class="fu">jsonvalidate</span><span class="fu">::</span><span class="fu">json_serialise</span><span class="op">(</span><span class="va">x</span>, <span class="va">schema</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] TRUE</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># It is typically much more efficient to construct a json_schema</span></span></span>
<span class="r-in"><span><span class="co"># object first and do both operations with it:</span></span></span>
<span class="r-in"><span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">jsonvalidate</span><span class="fu">::</span><span class="va"><a href="json_schema.html">json_schema</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">schema</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">json</span> <span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="fu">serialise</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">obj</span><span class="op">$</span><span class="fu">validate</span><span class="op">(</span><span class="va">json</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] TRUE</span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="https://ropensci.org/img/icon_short_white.svg"></div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://github.com/ropenscilabs" target="_blank" class="external-link"><div class="icon fa fa-flask"></div></a>
                        <a href="https://hachyderm.io/@ropensci" target="_blank" class="external-link"><div class="icon fab fa-mastodon"></div></a>
                        <a href="https://vimeo.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-vimeo"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul><h5 class="bottom-2">About</h5>
                            <li><a href="https://ropensci.org/about" class="external-link">About rOpenSci</a></li>
                            <li><a href="https://ropensci.org/software-review" class="external-link">Software Review</a></li>
                            <li><a href="https://ropensci.org/about#team" class="external-link">Our Team</a></li>
                            <li><a href="https://ropensci.org/careers" class="external-link">Jobs</a></li>
                            <li><a href="https://ropensci.org/donate" class="external-link">Donate</a></li>
                            <li><a href="https://ropensci.org/contact" class="external-link">Contact Us</a></li>
                        </ul></div>
                    <div class="col-md-3 col-sm-4">
                        <ul><h5 class="bottom-2">Community</h5>
                            <li><a href="https://ropensci.org/community/" class="external-link">Our Community</a></li>
                            <li><a href="https://ropensci.org/commcalls/" class="external-link">Community calls</a></li>
                            <li><a href="https://ropensci.org/events/" class="external-link">Events</a></li>
                            <li><a href="https://discuss.ropensci.org/" class="external-link">Join the Discussion</a></li>
                            <li><a href="https://ropensci.org/code-of-conduct" class="external-link">Code of conduct</a></li>
                        </ul></div>
                    <div class="col-md-2 col-sm-4">
                        <ul><h5 class="bottom-2">Resources</h5>
                            <li><a href="https://ropensci.org/packages/" class="external-link">Packages</a></li>
                            <li><a href="https://ropensci.org/usecases/" class="external-link">Use Cases</a></li>
                            <li><a href="https://ropensci.org/talks-papers/" class="external-link">Talks &amp; Publications</a></li>
                            <li><a href="https://docs.ropensci.org/" class="external-link">Documentation</a></li>
                            <li><a href="https://ropensci.org/news/" class="external-link">Newsletter</a></li>
                            <li><a href="https://ropensci.org/how-to-cite-ropensci/" class="external-link">Cite rOpenSci</a></li>
                        </ul></div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" class="external-link">NumFOCUS</a>.</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->


    </footer></div>

  

  

  </body></html>

